# 📈 基于 MACD 金叉的量化交易策略实现文档

## 一、策略技术实现

### 1. 策略逻辑

- **指标构建：**
  - 使用 EMA 构建 MACD 指标（DIF、DEA、MACD）。
  - 金叉（DIF 上穿 DEA）被识别为买入信号。
- **止盈止损逻辑：**
  - 金叉之后，若涨幅超过 5% → 卖出止盈；
  - 若跌幅超过 3% → 卖出止损。
- **数据处理：**
  - 对每只股票保留近 20 个交易日数据，并记录买入/卖出点。

### 2. 实现模块划分

| 模块名 | 功能说明 |
|--------|----------|
| `calculate_macd()` | 计算 MACD 三个关键值并标记买点（buy） |
| `apply_stop_logic()` | 根据买点寻找符合止盈/止损条件的卖点（sell） |
| `fetch_stock_codes()` | 获取数据库中所有股票代码 |
| `fetch_stock_data()` | 获取单支股票的完整历史行情 |
| `process_stock()` | 综合处理 MACD、止盈止损、信号筛选与数据生成 |
| `clean_nan_for_json()` | 处理 NaN 确保 JSON 格式合法 |
| `main()` | 遍历所有股票执行策略，生成 JSON 文件与统计信息 |

### 3. 数据源配置

- **数据库类型**：PostgreSQL
- **表名**：`all_stocks_days`
- **连接方式**：SQLAlchemy + psycopg2
- **字段包含**：
  - 股票代码、日期、开高低收、成交量、涨跌幅、均线、名称等

---

## 二、策略适用场景

| 场景 | 说明 |
|------|------|
| 📊 技术面选股 | 根据 MACD 指标信号寻找短期上涨趋势股 |
| 🔍 策略回测 | 可快速回顾历史中金叉信号的效果 |
| 🤖 自动交易辅助 | 可集成至自动交易系统中作为触发信号 |
| 🔁 多股筛选 | 扫描全市场找出当前存在有效信号的股票 |

---

## 三、当前问题与挑战

### 1. 数据层面

- 个别股票历史数据不足，无法计算有效指标。
- 原始数据中可能包含 NaN，需清洗后再处理。

### 2. 策略本身

- MACD 为滞后指标，可能错过第一波上涨。
- 止盈止损为固定比例，不适用于所有股票。
- 未考虑手续费、滑点等真实交易因素。

### 3. 性能瓶颈

- 目前处理为单线程、逐股查询方式，性能有限。

---

## 四、后续优化方向

### 1. 技术优化建议

| 优化项 | 说明 |
|--------|------|
| 🧵 并发处理 | 引入多线程或异步方案提高执行速度 |
| 📦 批量数据处理 | 一次性加载多只股票数据，减少数据库连接次数 |
| 📤 结果写入数据库 | 替代 JSON 输出，便于后续查询与展示 |
| ♻ 增量更新 | 仅处理当日有新增数据的股票，提升效率 |

### 2. 策略优化方向

| 优化项 | 说明 |
|--------|------|
| 💡 多因子增强 | 结合 RSI、布林带、量能等信号提升精度 |
| ⚖ 自适应阈值 | 根据波动率动态调整止盈止损比例 |
| 📉 风控机制 | 限制最大回撤、避免频繁买卖 |
| 🔬 机器学习 | 使用分类模型对金叉强度评分，提高信号质量 |

### 3. 展示层建议

- 利用 Vue3 + ECharts 展示 K 线图、MACD、买卖点等。
- 构建前端策略回测与可视化界面。
- 封装为 API 服务，供 Web / 小程序使用。

---

## 五、策略表现输出示例

- JSON 文件结构：
  ```json
  {
    "column_names": [...],
    "data": [
      [
        ["000001.SZ", "2025-04-10", 9.23, 9.50, 9.18, 9.40, ...]
      ],
      ...
    ],
    "stock_count": 42
  }
